---
/**
 * Base Layout - EXACT structure from original index.html
 * Includes all CSS, meta tags, scripts in the same order
 */
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getAlternatePath, normalizeUrl } from "../utils/i18n";

interface Props {
    title: string;
    description: string;
    canonical?: string;
}

const { title, description, canonical } = Astro.props;
const currentPath = Astro.url.pathname;
const isGerman = currentPath.startsWith("/de/");
const lang = isGerman ? "de" : "en";

// Canonical URL normalization
const baseUrl = "https://cameraupick.com";
const fullCanonical = canonical || normalizeUrl(currentPath);

// Language metadata
const alternatePath = getAlternatePath(currentPath);
const alternateUrl = `${baseUrl}${alternatePath === "/" ? "" : alternatePath}`;

// Generate JSON-LD structured data
const jsonLd = JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebPage",
    name: title,
    url: fullCanonical,
    description: description,
    inLanguage: lang,
    isPartOf: {
        "@type": "WebSite",
        name: "cameraupick",
        url: baseUrl,
        description: "Camera reviews, comparisons, and buying guides",
        publisher: {
            "@type": "Organization",
            name: "cameraupick",
            url: baseUrl,
            logo: {
                "@type": "ImageObject",
                url: `${baseUrl}/assets/images/logo.webp`,
                width: 28,
                height: 28,
            },
            sameAs: [
                "https://youtube.com/@Taylor-hv8bj",
                "https://www.instagram.com/astronaut_taylor",
            ],
        },
    },
    breadcrumb: {
        "@type": "BreadcrumbList",
        itemListElement: [
            {
                "@type": "ListItem",
                position: 1,
                name: isGerman ? "Startseite" : "Home",
                item: isGerman ? `${baseUrl}/de/` : baseUrl,
            },
        ],
    },
});
---

<!doctype html>
<html lang={lang} prefix="og: https://ogp.me/ns#">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content={description} />
        <meta name="robots" content="index,follow,max-image-preview:large" />
        <meta name="theme-color" content="#0b1220" />

        <!-- Google Search Console Verification -->
        <!-- TODO: Add verification code after setting up Google Search Console -->
        <!-- <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE" /> -->

        <!-- Font preload with optimized loading -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            rel="preload"
            as="style"
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
            onload="this.onload=null;this.rel='stylesheet'"
        />
        <noscript>
            <link
                rel="stylesheet"
                href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
            />
        </noscript>

        <!-- Preload critical resources for LCP -->
        <link
            rel="preload"
            as="image"
            imagesrcset="/assets/images/guides/main-page-640.webp 640w, /assets/images/guides/main-page-960.webp 960w, /assets/images/guides/main-page-1280.webp 1280w"
            imagesizes="(max-width: 768px) 100vw, 1280px"
            type="image/webp"
            fetchpriority="high"
        />

        <!-- CDN preconnect for Anime.js -->
        <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
        <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />

        <!-- Favicon / App Icons -->
        <link
            rel="icon"
            type="image/png"
            href="/assets/images/favicon.png?v=2"
        />
        <link rel="apple-touch-icon" href="/assets/images/favicon.png?v=2" />
        <link rel="manifest" href="/site.webmanifest" />

        <link rel="canonical" href={fullCanonical} />

        <!-- Hreflang tags for multilingual SEO -->
        <link
            rel="alternate"
            hreflang="en"
            href={isGerman ? alternateUrl : fullCanonical}
        />
        <link
            rel="alternate"
            hreflang="de"
            href={isGerman ? fullCanonical : alternateUrl}
        />
        <link
            rel="alternate"
            hreflang="x-default"
            href={isGerman ? alternateUrl : fullCanonical}
        />

        <!-- Open Graph / Twitter -->
        <meta property="og:type" content="website" />
        <meta property="og:site_name" content="cameraupick" />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta
            property="og:image"
            content="https://cameraupick.com/og-image.png"
        />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta
            property="og:image:alt"
            content="cameraupick - Camera Reviews, Comparisons & Buying Guides"
        />
        <meta
            property="og:url"
            content={canonical || "https://cameraupick.com"}
        />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta
            name="twitter:image"
            content="https://cameraupick.com/og-image.png"
        />
        <meta
            name="twitter:image:alt"
            content="cameraupick - Camera Reviews, Comparisons & Buying Guides"
        />

        <title>{title}</title>

        <!-- Structured Data (Schema.org JSON-LD) -->
        <script type="application/ld+json" set:html={jsonLd} />

        <!-- Additional head content slot (for page-specific schemas) -->
        <slot name="head" />

        <!-- Inline Critical CSS for LCP optimization -->
        <style>
            /* Critical above-the-fold styles */
            :root{--bg:#0d1322;--bg-soft:#10182b;--fg:#e9eef9;--muted:#95a1bf;--accent:#4da3ff;--accent-strong:#2b7fe2;--card:rgba(255,255,255,0.03);--shadow:0 24px 70px rgba(6,10,22,0.55);--radius:18px;--radius-sm:12px;--border:1px solid rgba(255,255,255,0.06)}
            *{box-sizing:border-box}
            body{margin:0;font-family:"Inter","Segoe UI",system-ui,sans-serif;background:radial-gradient(circle at 20% 20%,rgba(77,163,255,0.18),transparent 32%),var(--bg);color:var(--fg);line-height:1.7;padding-top:70px}
            .container{width:min(1100px,92vw);margin:0 auto}
            .hero{position:relative;background:linear-gradient(135deg,rgba(77,163,255,0.1),rgba(16,24,45,0.8));border-radius:16px;padding:28px;border:var(--border);box-shadow:var(--shadow)}
            .hero-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center}
            .hero h1{font-size:clamp(22px,3vw,32px);margin-bottom:10px;line-height:1.2;color:#f4f7ff}
            .hero-sub{font-size:14px;color:#b0b8d1;line-height:1.5}
            .quiz-card{background:linear-gradient(135deg,rgba(43,127,226,0.1),rgba(16,24,45,0.6));border:1px solid rgba(77,163,255,0.2);display:flex;align-items:center;justify-content:space-between;gap:18px;padding:22px 24px;border-radius:22px;flex-wrap:wrap}
            .quiz-title{color:#e9eef9;margin-bottom:6px}
            .quiz-desc{color:#b0b8d1;margin:0}
            @media (max-width:768px){.hero-grid{grid-template-columns:1fr}}
        </style>

        <!-- Main CSS - Render-blocking for stability (51KB, acceptable) -->
        <link rel="stylesheet" href="/assets/css/bundle.min.css" />

        <!-- Review page styles - Load async (non-critical) -->
        <link rel="preload" href="/assets/css/review-page.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
        <noscript><link rel="stylesheet" href="/assets/css/review-page.css" /></noscript>

        <!-- Table scroll indicators for mobile UX -->
        <link rel="stylesheet" href="/assets/css/table-scroll-indicator.css" />

        <!-- Google Analytics - Deferred for performance -->
        <link rel="preconnect" href="https://www.googletagmanager.com" />
        <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    </head>

    <body>
        <div class="reading-progress">
            <div class="progress-bar"></div>
        </div>

        <a class="skip-link" href="#main">Skip to content</a>

        <Header />

        <slot />

        <Footer />

        <!-- Scripts - Optimized for performance -->
        <script is:inline src="/assets/js/links.min.js?v=20260120" defer
        ></script>
        <script is:inline src="/assets/js/mega-menu.min.js" defer></script>
        <script is:inline src="/assets/js/table-scroll.js" defer></script>

        <!-- Main script - deferred and idle-loaded for minimal TBT -->
        <script is:inline>
            // Load main script after page is interactive
            function loadMainScript() {
                var s = document.createElement("script");
                s.src = "/assets/js/script.min.js";
                s.defer = true;
                document.body.appendChild(s);
            }
            if (window.requestIdleCallback) {
                requestIdleCallback(loadMainScript, { timeout: 1000 });
            } else {
                setTimeout(loadMainScript, 100);
            }
        </script>

        <!-- Service Worker Registration & Deferred Analytics -->
        <script is:inline>
            // Service Worker
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("/sw.js")
                        .then((reg) => console.log("SW registered"))
                        .catch((err) => console.log("SW registration failed"));
                });
            }

            // Deferred Google Analytics - loads after page is interactive
            function loadGA() {
                var s = document.createElement("script");
                s.async = true;
                s.src =
                    "https://www.googletagmanager.com/gtag/js?id=G-DLCVQGNSW4";
                document.head.appendChild(s);

                window.dataLayer = window.dataLayer || [];
                function gtag() {
                    dataLayer.push(arguments);
                }
                gtag("js", new Date());
                gtag("config", "G-DLCVQGNSW4");
            }

            // Load GA after page is fully loaded and idle
            if (window.requestIdleCallback) {
                requestIdleCallback(loadGA);
            } else {
                setTimeout(loadGA, 2000);
            }
        </script>

        <!-- Anime.js Animation Library - Idle loaded to avoid blocking LCP -->
        <script is:inline>
            // Load animations after page is interactive (avoid forced reflow)
            function loadAnimations() {
                var anime = document.createElement("script");
                anime.src =
                    "https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js";
                anime.onload = function () {
                    var anim = document.createElement("script");
                    anim.src = "/assets/js/animations.min.js";
                    document.body.appendChild(anim);
                };
                document.body.appendChild(anime);
            }
            if (window.requestIdleCallback) {
                requestIdleCallback(loadAnimations, { timeout: 3000 });
            } else {
                setTimeout(loadAnimations, 2000);
            }
        </script>
    </body>
</html>
